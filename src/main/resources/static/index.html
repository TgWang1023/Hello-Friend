<!-- switch 控制tab切换 -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hello-Friend-Home</title>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <script src="/webjars/jquery/jquery.min.js"></script>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
    <script src="https://www.webrtc-experiment.com/RecordRTC.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

    <script type='text/javascript' src="/app.js"></script>
    <!-- <script type="text/javascript" src="/audio.js"></script> -->
    <link rel="stylesheet" type="text/css" href="./css/home.css"/>
    <link href="./css/chat.css" rel="stylesheet">

</head>

<body>

<div class="container-fluid">
    <!-- connect and disconnect -->
    <nav class="navbar navbar-light" style="background-color: #107595">
        <form class="form-inline">
            <button id="connect" class="btn btn-outline-light" type="submit">Connect</button>
            <button id="disconnect" class="btn btn-outline-light" type="submit" disabled="disabled">Disconnect</button>
        </form>
    </nav>

    <!-- connect and disconnect ends -->
    <div class="row">
        <!-- room section -->
        <div class="col-md-4">
            <!-- create/join room form section -->
            <div id="room_form" class="show-card">
                <ul class="tab">
                    <li class="tab-item active">Create</li>
                    <li class="tab-item">Join</li>
                </ul>

                <div id="create_join" class="cards">
                    <!-- create section -->
                    <div class="mod-box selected">
                        <div id="create_room_section" class="mod-box-content">
                            <form action="" method="post">
                                <div style="position: relative;">
                                    <div class="form-item">
                                        <label class="s-label mb4">Your Name</label>
                                        <input type="text" id="user_name" name="name"
                                               placeholder="Tom" class="s-input">
                                    </div>
                                </div>

                                <div style="position: relative;">
                                    <div class="form-item">
                                        <label class="s-label mb4">Your Language</label>
                                        <select class="custom-select mr-sm-2" id="user_lang">
                                            <option selected>Choose...</option>
                                            <option value="en">English</option>
                                            <option value="ja">Japanese</option>
                                            <option value="ko">Korean</option>
                                            <option value="zh-CN">Simplified Chinese</option>
                                            <option value="zh-TW">Traditional Chinese</option>
                                        </select>
                                    </div>
                                </div>

                                <div style="position: relative;">
                                    <div class="form-item">
                                        <label class="s-label mb4">Room Name</label>
                                        <input type="text" id="room_name" name="roomN"
                                               placeholder="12345" class="s-input">
                                    </div>
                                </div>

                                <div>
                                    <button id="create_room" class="s-btn" type="submit" tabindex="120">
                                        create a room
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- create section ends -->

                    <!-- join section -->
                    <div class="mod-box">
                        <div id="join_room_section" class="mod-box-content">
                            <form action="" method="post">

                                <div style="position: relative;">
                                    <div class="form-item">
                                        <label class="s-label mb4">Your Name</label>
                                        <input type="text" id="join_user_name" name="name"
                                               placeholder="Jerry" class="s-input">
                                    </div>
                                </div>

                                <div style="position: relative;">
                                    <div class="form-item">
                                        <label class="s-label mb4">Your Language</label>
                                        <select class="custom-select mr-sm-2" id="join_user_lang">
                                            <option selected>Choose...</option>
                                            <option value="en">English</option>
                                            <option value="ja">Japanese</option>
                                            <option value="ko">Korean</option>
                                            <option value="zh-CN">Simplified Chinese</option>
                                            <option value="zh-TW">Traditional Chinese</option>
                                        </select>
                                    </div>
                                </div>

                                <div style="position: relative;">
                                    <div class="form-item">
                                        <label class="s-label mb4">Room Name</label>
                                        <input type="text" id="join_room_name" name="roomN"
                                               placeholder="12345" class="s-input">
                                    </div>
                                </div>

                                <div>
                                    <button id="join_room" class="s-btn" type="submit" tabindex="120">
                                        join a room
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- join section ends -->

                </div>
            </div>
            <!-- create/join room section ends -->
        </div>
        <!--$$$$$$$$$$$$$$$$- -->
        <!--$$$$$$$$$$$$$$$$- -->

        <!-- chat section -->
        <div class="col-md-4">
            <div id="chat_section" class="show-card">
                <div class="panel panel-primary">
                    <div class="panel-heading" id="accordion">
                        <span class="glyphicon glyphicon-comment"></span>
                        Chat
                    </div>

                    <div class="panel-body">
                        <ul class="chat" id="conversation">
                            <li class="left">
                            <span class="d-inline-block chat-img">
                                <img src="http://placehold.it/50/55C1E7/fff&text=U" alt="User Avatar"
                                     class="img-circle"/>
                            </span>
                                <span class="d-inline-block chat-body">
                                <div class="header">
                                    <strong class="primary-font">Jack Sparrow</strong> <small
                                        class="pull-right text-muted">
                                        <span class="glyphicon glyphicon-time"></span>12 mins ago
                                    </small>
                                </div>
                                <p>
                                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur bibendum ornare
                                    dolor, quis ullamcorper ligula sodales.
                                </p>
                            </span>
                            </li>

                            <li class="right">
                          <span class="chat-img d-inline-block">
                              <img src="http://placehold.it/50/FA6F57/fff&text=ME" alt="User Avatar"
                                   class="img-circle"/>
                          </span>
                                <span class="chat-body d-inline-block">
                                <div class="header">

                                    <strong class="pull-right primary-font">Bhaumik Patel</strong>
                                    <small class=" text-muted"><span class="glyphicon glyphicon-time"></span>13 mins ago</small>
                                </div>
                                <p>
                                    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur bibendum ornare
                                    dolor, quis ullamcorper ligula sodales.
                                </p>
                            </span>

                            </li>

                        </ul>
                    </div>
                </div>

                <div class="panel-footer" id="message_form">
                    <div class="input-group">
                        <input id="room_msg" type="text" class="form-control input-sm"
                               placeholder="Type your message here..."/>
                        <span class="input-group-btn">
                        <button class="btn btn-warning btn-sm full-h" id="send_msg">
                            Send
                        </button>
                    </span>
                    </div>
                </div>

            </div>
        </div>

        <div class="col-md-4">
            <div id="audio" class="show-card">
                <div class="form-item">
                    <button id="btn-start-recording">Start Recording</button>
                </div>
                <div class="form-item">
                    <button id="btn-stop-recording" disabled>Stop Recording</button>
                </div>
                <div class="form-item">
                    <button id="btn-release-microphone" disabled>Release Microphone</button>
                </div>
                <div class="form-item">
                    <button id="btn-download-recording" disabled>Download</button>
                </div>
                <div class="form-item">
                    <button id="btn-convert-base64">Convert Base64</button>
                </div>
                <div>
                    <audio controls autoplay playsinline></audio>
                </div>

            </div>
        </div>
    </div>

    <!-- chat section ends -->
    <!--$$$$$$$$$$$$$$$$- -->
    <!--$$$$$$$$$$$$$$$$- -->

</div>

</body>

<script type="text/javascript">
//控制tab切换
$(function(){
    $("#create_join .mod-box").eq(0).show().siblings().hide();
    $(".tab-item").click(function () {
    $(this).addClass("active").siblings().removeClass("active");
    $("#create_join .mod-box").eq($(this).index()).show().siblings().hide();
})});
</script>

<!-- <script>
var audio = document.querySelector('audio');

function captureMicrophone(callback) {
    btnReleaseMicrophone.disabled = false;

    if(microphone) {
        callback(microphone);
        return;
    }

    if(typeof navigator.mediaDevices === 'undefined' || !navigator.mediaDevices.getUserMedia) {
        alert('This browser does not supports WebRTC getUserMedia API.');

        if(!!navigator.getUserMedia) {
            alert('This browser seems supporting deprecated getUserMedia API.');
        }
    }

    navigator.mediaDevices.getUserMedia({
        audio: isEdge ? true : {
            echoCancellation: false
        }
    }).then(function(mic) {
        callback(mic);
    }).catch(function(error) {
        alert('Unable to capture your microphone. Please check console logs.');
        console.error(error);
    });
}

function replaceAudio(src) {
    var newAudio = document.createElement('audio');
    newAudio.controls = true;
    newAudio.autoplay = true;

    if(src) {
        newAudio.src = src;
    }

    var parentNode = audio.parentNode;
    parentNode.innerHTML = '';
    parentNode.appendChild(newAudio);

    audio = newAudio;
}

function stopRecordingCallback() {
    replaceAudio(URL.createObjectURL(recorder.getBlob()));

    btnStartRecording.disabled = false;

    setTimeout(function() {
        if(!audio.paused) return;

        setTimeout(function() {
            if(!audio.paused) return;
            audio.play();
        }, 1000);

        audio.play();
    }, 300);

    audio.play();

    btnDownloadRecording.disabled = false;

    if(isSafari) {
        click(btnReleaseMicrophone);
    }
}

var isEdge = navigator.userAgent.indexOf('Edge') !== -1 && (!!navigator.msSaveOrOpenBlob || !!navigator.msSaveBlob);
var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

var recorder; // globally accessible
var microphone;

var btnStartRecording = document.getElementById('btn-start-recording');
var btnStopRecording = document.getElementById('btn-stop-recording');
var btnReleaseMicrophone = document.querySelector('#btn-release-microphone');
var btnDownloadRecording = document.getElementById('btn-download-recording');

btnStartRecording.onclick = function() {
    this.disabled = true;
    this.style.border = '';
    this.style.fontSize = '';

    if (!microphone) {
        captureMicrophone(function(mic) {
            microphone = mic;

            if(isSafari) {
                replaceAudio();

                audio.muted = true;
                audio.srcObject = microphone;

                btnStartRecording.disabled = false;
                btnStartRecording.style.border = '1px solid red';
                btnStartRecording.style.fontSize = '150%';

                alert('Please click startRecording button again. First time we tried to access your microphone. Now we will record it.');
                return;
            }

            click(btnStartRecording);
        });
        return;
    }

    replaceAudio();

    audio.muted = true;
    audio.srcObject = microphone;

    var options = {
        type: 'audio',
        numberOfAudioChannels: isEdge ? 1 : 2,
        checkForInactiveTracks: true,
        bufferSize: 16384
    };

    if(isSafari || isEdge) {
        options.recorderType = StereoAudioRecorder;
    }

    if(navigator.platform && navigator.platform.toString().toLowerCase().indexOf('win') === -1) {
        options.sampleRate = 48000; // or 44100 or remove this line for default
    }

    if(isSafari) {
        options.sampleRate = 44100;
        options.bufferSize = 4096;
        options.numberOfAudioChannels = 2;
    }

    if(recorder) {
        recorder.destroy();
        recorder = null;
    }

    recorder = RecordRTC(microphone, options);

    recorder.startRecording();

    btnStopRecording.disabled = false;
    btnDownloadRecording.disabled = true;
};

btnStopRecording.onclick = function() {
    this.disabled = true;
    recorder.stopRecording(stopRecordingCallback);
};

btnReleaseMicrophone.onclick = function() {
    this.disabled = true;
    btnStartRecording.disabled = false;

    if(microphone) {
        microphone.stop();
        microphone = null;
    }

    if(recorder) {
        // click(btnStopRecording);
    }
};

btnDownloadRecording.onclick = function() {
    this.disabled = true;
    if(!recorder || !recorder.getBlob()) return;

    if(isSafari) {
        recorder.getDataURL(function(dataURL) {
            SaveToDisk(dataURL, getFileName('mp3'));
        });
        return;
    }

    var blob = recorder.getBlob();
    var file = new File([blob], getFileName('mp3'), {
        type: 'audio/mp3'
    });
    invokeSaveAsDialog(file);
};

function click(el) {
    el.disabled = false; // make sure that element is not disabled
    var evt = document.createEvent('Event');
    evt.initEvent('click', true, true);
    el.dispatchEvent(evt);
}

function getRandomString() {
    if (window.crypto && window.crypto.getRandomValues && navigator.userAgent.indexOf('Safari') === -1) {
        var a = window.crypto.getRandomValues(new Uint32Array(3)),
            token = '';
        for (var i = 0, l = a.length; i < l; i++) {
            token += a[i].toString(36);
        }
        return token;
    } else {
        return (Math.random() * new Date().getTime()).toString(36).replace(/\./g, '');
    }
}

function getFileName(fileExtension) {
    var d = new Date();
    var year = d.getFullYear();
    var month = d.getMonth();
    var date = d.getDate();
    return 'RecordRTC-' + year + month + date + '-' + getRandomString() + '.' + fileExtension;
}

function SaveToDisk(fileURL, fileName) {
    // for non-IE
    if (!window.ActiveXObject) {
        var save = document.createElement('a');
        save.href = fileURL;
        save.download = fileName || 'unknown';
        save.style = 'display:none;opacity:0;color:transparent;';
        (document.body || document.documentElement).appendChild(save);

        if (typeof save.click === 'function') {
            save.click();
        } else {
            save.target = '_blank';
            var event = document.createEvent('Event');
            event.initEvent('click', true, true);
            save.dispatchEvent(event);
        }

        (window.URL || window.webkitURL).revokeObjectURL(save.href);
    }

    // for IE
    else if (!!window.ActiveXObject && document.execCommand) {
        var _window = window.open(fileURL, '_blank');
        _window.document.close();
        _window.document.execCommand('SaveAs', true, fileName || fileURL)
        _window.close();
    }
}
</script> -->

<script src="https://www.webrtc-experiment.com/common.js"></script>
